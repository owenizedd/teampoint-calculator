<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Calculator</title>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<style>
    .float-info{
        position: fixed;
        right: 10px;
        top: 5px;
        background: #444;
        color: white;
        padding: 5px;
        border-radius: 5px;
        opacity: 0.9;
        transition: 300ms all;
    }
    .float-info ul{
        margin: 0;
        padding: 0;
        transition: 300ms all;
    }
</style>
</head>
<body style="margin: 10px 15px">
    <div class="jumbotron">
        <h3>Kalkulator Hitung Peringkat Turnamen FreeFire</h3>
    </div>
    <hr>
    <div class="teams">
        <div class="tim1-container">
            <div class="form-group">
                <label for="tim1-name">Masukkan Nama Tim1</label>
                <input type="text" class="form-control" id="tim1-name">
            </div>
            <div class="form-group">
                <label for="tim1-score">Masukkan poin Tim1, dipisah koma (misalnya: 10,2,3)</label>
                <input type="text" class="form-control score-field" name=""  id="tim1-score">
            </div>
        </div>
        <hr>
        <div id='new-team'></div>
    </div>
    <button type="button" class="btn btn-info" id="add-team">Tambah tim</button>
    <button type="button" class="btn btn-primary" id="calculate">Hitung dan dapatkan peringkat</button>
    <br/><br/>
    <button type="button" class="btn btn-danger" id="clear-storage-btn">Hapus semua data</button>
    <h4 id="header-scoreboard" style="display: none">Juara:</h4>
    <ol id="scoreboard">

    </ol>
    <div class="float-info" style='max-height: 350px'>
        <p>Nilai peringkat ke poin</p>
        <ul style='overflow: hidden'>
            <li>Peringkat 1: 12 Poin</li>
            <li>Peringkat 2: 9 Poin</li>
            <li>Peringkat 3: 8 Poin</li>
            <li>Peringkat 4: 7 Poin</li>
            <li>Peringkat 5: 6 Poin</li>
            <li>Peringkat 6: 5 Poin</li>
            <li>Peringkat 7: 4 Poin</li>
            <li>Peringkat 8: 3 Poin</li>
            <li>Peringkat 9: 2 Poin</li>
            <li>Peringkat 10: 1 Poin</li>
            <li>Peringkat 11: 0 Poin</li>
            <li>Peringkat 12: 0 Poin</li>
            <br>
        </ul>
        <button class="btn btn-warning" id="toggle-float">Tutup/Buka</button>
    </div>
</body>
<script>
    let totalTeam = 1;
    function addTeam(){
        ++totalTeam;
        console.log('adding');
        let teamHTML =document.querySelector('.tim1-container').innerHTML;
        teamHTML = teamHTML.replaceAll('tim1', 'tim' + totalTeam);
        teamHTML = teamHTML.replaceAll('Tim1', 'Tim' + totalTeam);
        document.querySelector('#new-team').outerHTML = teamHTML + '<hr><div id="new-team"></div>';
        saveDataToStorage();
    }
    function addTeamNoStorage(){
        ++totalTeam;
        console.log('adding');
        let teamHTML =document.querySelector('.tim1-container').innerHTML;
        teamHTML = teamHTML.replaceAll('tim1', 'tim' + totalTeam);
        teamHTML = teamHTML.replaceAll('Tim1', 'Tim' + totalTeam);
        document.querySelector('#new-team').outerHTML = teamHTML + '<hr><div id="new-team"></div>';
    }
    document.querySelector('#add-team').onclick = addTeam;
    document.querySelector('#calculate').onclick = function(){
        let data = [];
        Array.from(document.querySelectorAll('.score-field')).forEach( (scoreInput) => {
            let sum = scoreInput.value.split(",").map(val => +val).reduce((a,b) => a + b);
            let name = document.querySelector('#' + scoreInput.id.replace('score','name')).value;
            data.push({ name, sum });
            console.log(sum, name)
        })
        ranks = data.sort((a,b) => a.sum > b.sum ? 1 : -1).reverse().map(team => `<li>${team.name} - ${team.sum}</li>`).join("");
        document.querySelector('#scoreboard').innerHTML = ranks;
        document.querySelector('#header-scoreboard').style.display='block';
        
    }
    document.querySelector('#toggle-float').onclick= function(){
        const floatInfo = document.querySelector('.float-info');
        const ulList = floatInfo.querySelector('ul');
        const curHeight = floatInfo.style.maxHeight;
        if (curHeight === '350px'){
            floatInfo.style.maxHeight = '0px'
            ulList.style.maxHeight = '0px';
        }
        else {
            floatInfo.style.maxHeight = '350px'
            ulList.style.maxHeight = '350px'
        }
    }

    document.querySelector('#clear-storage-btn').onclick = function () {
        
        if (window.confirm("Apakah yakin menghapus data?")){
            localStorage.clear();
            window.location.reload();
        }
    }

    let data = []
    function saveDataToStorage(){
        let length = Array.from(document.querySelectorAll('.score-field')).length;
        data.length = length;
        Array.from(document.querySelectorAll('.score-field')).forEach( (scoreInput, index) => {
            scoreInput.oninput = function(){
                let sum = this.value;
                let name = document.querySelector('#' + this.id.replace('score','name')).value;
                data[index] = { name, sum };
                localStorage.setItem('scores', JSON.stringify(data));
            }
        })
    }
    function loadDataFromStorage(){
        const scores = JSON.parse(localStorage.getItem('scores'));
        if (Array.isArray(scores)){
            data = scores;
            for(let i = 0; i< scores.length - 1; i++){
                addTeamNoStorage();
            }
            console.log(Array.from(document.querySelectorAll('.score-field')).length)
            Array.from(document.querySelectorAll('.score-field')).forEach( (scoreInput, index) => {
                scoreInput.value = scores[index].sum;
                let name = document.querySelector('#' + scoreInput.id.replace('score','name')).value = scores[index].name;
            })
        }
    }
    
    this.loadDataFromStorage();
    this.saveDataToStorage();
</script>
</html>